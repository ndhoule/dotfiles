#!/usr/bin/env bash

#
# Perform an install of all developer dependencies.
#

set -o errexit
set -o nounset
set -o pipefail

log_info() {
  echo "[INFO]: $*"
}

log_warn() {
  echo "[WARN]: $*"
}

log_error() {
  echo "[ERROR]: $*"
}

CURRENT_SCRIPT_PATH="$(cd "$(dirname "$0")" ; pwd -P)"

# Validate that the current OS is supported
case "${OSTYPE}" in
  darwin* | linux*):
    # continue
    ;;
  *):
    log_error "Unsupported OS: '${OSTYPE}'"
    exit 1
    ;;
esac

#
# Check dependencies
#

if [[ -z "${GOPATH}" ]]; then
  log_error "Must set GOPATH before running this script."
  exit 1
fi

#
# Install dependencies
#

case "${OSTYPE}" in
  darwin*):
    "${CURRENT_SCRIPT_PATH}/osx/install"
    ;;
  linux*):
    "${CURRENT_SCRIPT_PATH}/linux/install"
    ;;
esac

#
# Link dotfiles
#

packages=(
  "ag"
  "bin"
  "clojure"
  "emacs"
  "git"
  "haskell"
  "javascript"
  "ruby"
  "ssh"
  "tmux"
  "vim"
  "zsh"
)

if command -v stow > /dev/null 2>&1; then
  log_info "Symlinking dotfiles into $HOME..."
  for pkg in "${packages[@]}"; do
    pushd "${CURRENT_SCRIPT_PATH}/packages" > /dev/null
    stow --target="$HOME" --verbose=1 "${pkg}"
    popd > /dev/null
  done
  log_info "Symlinked dotfiles into $HOME."
else
  log_warn "stow not installed. Skipping dotfiles symlinking..."
fi

#
# Install language packages
#

go_packages=(
  "github.com/alecthomas/gometalinter"
  "github.com/kardianos/govendor"
  "github.com/nsf/gocode"
  "golang.org/x/tools/cmd/gorename"
  "golang.org/x/tools/cmd/guru"
)

if command -v go > /dev/null 2>&1; then
  log_info "Installing Go packages..."
  for pkg in "${go_packages[@]}"; do
    go get -u "${pkg}"
  done
  log_info "Installed Go packages."
else
  log_warn "Go not installed. Skipping package installation."
fi
